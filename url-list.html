<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>サイトURL一覧</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --bg: #f5f7fa;
  --surface: #ffffff;
  --border: #e0e0e0;
  --text: #333333;
  --text-muted: #666666;
  --accent: #4a90d9;
  --accent-hover: #3a7bc8;
  --shadow: 0 2px 12px rgba(0,0,0,0.08);
  --radius: 10px;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Noto Sans JP', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 800px;
  margin: 0 auto;
}

header {
  text-align: center;
  margin-bottom: 32px;
  padding: 32px 20px;
  background: linear-gradient(135deg, #4a90d9, #7b68ee);
  border-radius: var(--radius);
  color: #fff;
  box-shadow: var(--shadow);
}

header h1 {
  font-size: 1.8em;
  margin-bottom: 8px;
}

header p {
  font-size: 0.95em;
  opacity: 0.9;
}

.status-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding: 10px 16px;
  background: var(--surface);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  font-size: 0.85em;
  color: var(--text-muted);
}

.status-bar .last-updated {
  display: flex;
  align-items: center;
  gap: 6px;
}

.status-bar button {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 6px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85em;
  transition: background 0.2s;
}

.status-bar button:hover {
  background: var(--accent-hover);
}

.status-bar button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.url-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.url-card {
  background: var(--surface);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px 24px;
  transition: transform 0.15s, box-shadow 0.15s;
  text-decoration: none;
  color: inherit;
  display: block;
  border-left: 4px solid var(--accent);
}

.url-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}

.url-card .page-title {
  font-size: 1.15em;
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--text);
}

.url-card .page-url {
  font-size: 0.85em;
  color: var(--accent);
  word-break: break-all;
}

.url-card .page-meta {
  font-size: 0.8em;
  color: var(--text-muted);
  margin-top: 8px;
  display: flex;
  gap: 16px;
}

.loading {
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
}

.spinner {
  display: inline-block;
  width: 24px;
  height: 24px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 12px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error {
  text-align: center;
  padding: 24px;
  background: #fff3f3;
  border-radius: var(--radius);
  color: #c0392b;
  border: 1px solid #f5c6cb;
}

footer {
  text-align: center;
  margin-top: 32px;
  padding: 16px;
  font-size: 0.8em;
  color: var(--text-muted);
}

@media (max-width: 600px) {
  body { padding: 12px; }
  header { padding: 24px 16px; }
  header h1 { font-size: 1.4em; }
  .url-card { padding: 16px; }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>サイトURL一覧</h1>
    <p>j-san-1.github.io/1st-repository 内の全ページ</p>
  </header>

  <div class="status-bar">
    <span class="last-updated" id="lastUpdated">読み込み中...</span>
    <button id="refreshBtn" onclick="loadPages()">更新</button>
  </div>

  <div class="url-list" id="urlList">
    <div class="loading">
      <div class="spinner"></div>
      <p>ページ一覧を取得中...</p>
    </div>
  </div>

  <footer>
    データは GitHub API から動的に取得されます
  </footer>
</div>

<script>
const BASE_URL = 'https://j-san-1.github.io/1st-repository/';
const API_URL = 'https://api.github.com/repos/j-san-1/1st-repository/contents/';
const CACHE_KEY = 'url-list-cache';
const CACHE_DURATION = 5 * 60 * 1000; // 5分

// タイトル取得用のマッピング（フォールバック）
const KNOWN_PAGES = {
  'index.html': { title: '製薬業界ニュース', description: '製薬業界の最新ニュースを企業別に閲覧' },
  'index2.html': { title: '家族カレンダー', description: '家族のスケジュールをまとめて管理' },
  'chousei.html': { title: 'みんなの日程調整', description: '複数人の予定を○△×で調整' },
  'url-list.html': { title: 'サイトURL一覧', description: 'サイト内の全ページ一覧（このページ）' }
};

function getCachedData() {
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    if (!cached) return null;
    const parsed = JSON.parse(cached);
    if (Date.now() - parsed.timestamp > CACHE_DURATION) return null;
    return parsed;
  } catch {
    return null;
  }
}

function setCachedData(files) {
  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify({
      timestamp: Date.now(),
      files: files
    }));
  } catch {}
}

async function fetchTitleFromPage(url) {
  try {
    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
    const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(5000) });
    if (!resp.ok) return null;
    const html = await resp.text();
    const match = html.match(/<title[^>]*>([^<]+)<\/title>/i);
    return match ? match[1].trim() : null;
  } catch {
    return null;
  }
}

async function loadPages() {
  const listEl = document.getElementById('urlList');
  const refreshBtn = document.getElementById('refreshBtn');
  const lastUpdatedEl = document.getElementById('lastUpdated');

  refreshBtn.disabled = true;
  refreshBtn.textContent = '取得中...';

  // キャッシュ確認（更新ボタン押下時はスキップ）
  const isManualRefresh = event && event.type === 'click';

  try {
    const resp = await fetch(API_URL);
    if (!resp.ok) throw new Error('API request failed: ' + resp.status);
    const contents = await resp.json();

    // HTMLファイルのみ抽出（.htmlで終わるファイル）
    const htmlFiles = contents
      .filter(item => item.type === 'file' && item.name.endsWith('.html'))
      .map(item => ({
        name: item.name,
        size: item.size,
        url: BASE_URL + item.name,
        directUrl: BASE_URL + item.name,
        sha: item.sha
      }));

    // タイトルを取得（既知のページはマッピングを使用、不明なページはフェッチ試行）
    const pagesWithTitles = await Promise.all(htmlFiles.map(async (file) => {
      const known = KNOWN_PAGES[file.name];
      if (known) {
        return { ...file, title: known.title, description: known.description };
      }
      // 不明なページのタイトルを取得試行
      const fetchedTitle = await fetchTitleFromPage(file.directUrl);
      return {
        ...file,
        title: fetchedTitle || file.name,
        description: ''
      };
    }));

    // index.html を先頭にソート
    pagesWithTitles.sort((a, b) => {
      if (a.name === 'index.html') return -1;
      if (b.name === 'index.html') return 1;
      return a.name.localeCompare(b.name);
    });

    setCachedData(pagesWithTitles);
    renderList(pagesWithTitles);

    const now = new Date();
    lastUpdatedEl.textContent = '最終取得: ' + now.toLocaleString('ja-JP');

  } catch (err) {
    console.error('Failed to fetch from API:', err);

    // キャッシュがあればそれを使用
    const cached = getCachedData();
    if (cached) {
      renderList(cached.files);
      const cachedTime = new Date(cached.timestamp);
      lastUpdatedEl.textContent = 'キャッシュ表示: ' + cachedTime.toLocaleString('ja-JP');
    } else {
      // フォールバック: 既知のページ一覧を表示
      const fallbackPages = Object.entries(KNOWN_PAGES).map(([name, info]) => ({
        name,
        url: BASE_URL + name,
        directUrl: BASE_URL + name,
        title: info.title,
        description: info.description,
        size: null
      }));
      renderList(fallbackPages);
      lastUpdatedEl.textContent = '静的データを表示中（API接続エラー）';
    }
  } finally {
    refreshBtn.disabled = false;
    refreshBtn.textContent = '更新';
  }
}

function renderList(pages) {
  const listEl = document.getElementById('urlList');
  if (pages.length === 0) {
    listEl.innerHTML = '<div class="error">HTMLページが見つかりませんでした。</div>';
    return;
  }

  listEl.innerHTML = pages.map(page => {
    const sizeText = page.size ? formatSize(page.size) : '';
    const descText = page.description ? '<div class="page-meta"><span>' + escapeHtml(page.description) + '</span></div>' : '';
    const metaItems = [];
    if (sizeText) metaItems.push(sizeText);
    metaItems.push(page.name);

    return '<a class="url-card" href="' + escapeHtml(page.url) + '" target="_blank" rel="noopener">' +
      '<div class="page-title">' + escapeHtml(page.title) + '</div>' +
      '<div class="page-url">' + escapeHtml(page.url) + '</div>' +
      descText +
      (metaItems.length ? '<div class="page-meta"><span>' + metaItems.join(' / ') + '</span></div>' : '') +
      '</a>';
  }).join('');
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  const kb = (bytes / 1024).toFixed(1);
  if (kb < 1024) return kb + ' KB';
  const mb = (bytes / (1024 * 1024)).toFixed(1);
  return mb + ' MB';
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// 初回読み込み
loadPages();
</script>
</body>
</html>
